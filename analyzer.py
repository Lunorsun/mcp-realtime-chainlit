import re
from typing import Dict

# 한국어 키워드 기반 감정 매핑 (가중치 포함)
EMOTION_KEYWORDS = {
    "성취": [
    "해냈", "성공", "이뤘", "완료", "성취", "좋았", "즐거", "행복", "뿌듯", "자랑", "멋있",
    "잘했", "보람", "만족", "칭찬", "승리", "우승", "달성", "최고", "뿌듯함", "완벽", "자신감",
    "이룬", "해냈다", "잘했다", "뿌듯해", "성취감", "보람찼", "기쁨", "대단", "자랑스러움",
    "성공적", "보람된", "이루었다", "완수", "업적", "달성함", "승리감", "승리했", "완벽함",
    "이룬것", "성공적이었", "최상", "만족감", "업적달성", "해냈구나", "해냈다니", "뿌듯한", "칭찬받았",
    "달성했다", "성취했다", "기쁘다", "행복감", "즐거움", "보람차다"
    ],
    
    "기대": [
    "기대", "설렌", "기대돼", "고대", "설렘", "신나", "기뻐", "흥분", "두근", "궁금",
    "기다려", "마음이 설레", "행복한 예감", "즐거운 상상", "희망", "anticipation", "미래",
    "좋은 일", "설레임", "설레는", "두근거림", "가슴뛰", "즐거움", "기대감", "흥분됨",
    "신남", "기대중", "기대된다", "행복한 기대", "희망적", "설레여", "설렘가득", "두근두근",
    "마음두근", "앞으로 기대", "행복예감", "고대중", "기대높음", "기대함", "마음이 두근", "설레임가득",
    "두근거림가득", "행복예상", "기대되는", "기대감있음", "두근설레", "설렘느낌", "희망찬", "신나는",
    "행복감있음", "설렘가득함", "앞으로 기대됨", "행복기대"
    ],
    
    "불안": [
    "불안", "걱정", "초조", "긴장", "두려", "무서", "두렵", "떨려", "공포", "힘들", "우울",
    "속상", "괴로", "불확실", "불편", "혼란스러", "좌절", "짜증", "긴장돼", "초조해", "두근거려",
    "초조함", "겁", "위축", "고민", "불만", "막막", "불안감", "불안해", "걱정돼", "걱정중", "불안정",
    "마음불안", "두려움", "공포감", "심란", "긴장감", "무섭", "초조함가득", "불안함", "마음초조",
    "걱정많음", "불확실성", "심리적압박", "긴장함", "초조상태", "막막함", "두근거림", "두려움가득",
    "마음조급", "걱정스러움", "걱정되어", "겁먹음", "긴장되어", "마음불안정", "초조함심함", "불안심리",
    "심리불안", "불안정한상태"
    ],
    
    "고요": [
    "편안", "안정", "차분", "평온", "고요", "쉬었", "쉬어", "편했", "여유", "느긋",
    "조용", "평화", "한적", "안락", "고요함", "차분함", "자연스러움", "느림", "심신 안정",
    "편안함", "조용함", "평화로움", "평온함", "고요한", "차분한", "한가", "여유로움", "편하게", 
    "느긋함", "한적함", "안정적", "안정감", "편히", "마음편안", "마음평온", "심리안정", "차분해",
    "편안한기분", "여유있음", "마음안정", "마음고요", "심신평화", "고요감", "평화로운마음", "편안함느낌",
    "한적한", "차분한마음", "안락감", "조용한분위기", "마음느긋", "평온한", "심리적안정", "여유로운", "편함"
    ],
    
    "회피": [
    "피하고", "도망", "회피", "피했", "미뤘", "피하", "싫어", "꺼려", "무시", "회피하고싶",
    "가기싫", "참기싫", "피할래", "멀리하고싶", "회피적", "도망가고싶", "피하려고", "거리두기",
    "꺼림칙", "마주치기싫음", "피하기", "도망치고싶", "회피중", "마주하기싫", "회피하고있음", "피하고싶음",
    "멀리하고", "꺼려함", "피하려함", "피하고싶다", "도망가고싶다", "꺼림", "거리를두고싶음", "회피성향",
    "마주치기어려움", "피함", "도망치려함", "꺼림칙함", "회피심리", "멀리하고싶다", "피하려고함",
    "회피태도", "도망가", "마주치기싫다", "피하는중", "피하고싶어", "회피감", "회피성", "회피행동",
    "회피적마음", "도망치고싶음"
    ],
    
    "지침": [
    "혼란", "모르겠", "갈피", "어찌할", "답답", "뭔가", "뭐하지", "뭐해야", "막막", "헷갈",
    "어려워", "난감", "고민", "머리아파", "길을 잃은", "방황", "어리둥절", "혼돈", "갈등",
    "결정못함", "혼란스러움", "막막함", "혼란중", "갈피못잡음", "막막한", "어찌할지모름",
    "혼란스러운", "어리둥절함", "머리복잡", "난처", "결정장애", "방향잃음", "막막상태", "고민중",
    "혼란심리", "헷갈림", "난처함", "갈팡질팡", "혼란스러움가득", "어찌해야할지", "갈팡질팡함",
    "갈피없음", "혼돈상태", "어리둥절상태", "갈팡질팡중", "머리복잡함", "막막심리", "혼란감", "고민많음",
    "막막감", "방황중"
    ],
    
    "분노": [
    "화나", "열받", "짜증", "억울", "분통", "성질", "속상", "격분", "분개", "불쾌", "울컥",
    "짜증나", "분함", "열폭", "참기힘들어", "화남", "분노", "격노", "짜증남", "성난",
    "억울함", "격분함", "울분", "흥분", "화", "화가나", "짜증스러움", "억울한", "분노감",
    "짜증남가득", "화났음", "분개함", "격분중", "울분가득", "짜증가득", "참을수없음",
    "분노심리", "화심", "격노중", "화났어", "분함가득", "성질난", "분노중", "짜증섞임",
    "억울감", "격분함가득", "화기", "짜증심리", "분노표현", "분노심", "울분심리", "분노강"
    ],
    
    "슬픔": [
    "슬퍼", "우울", "눈물", "속상", "상심", "그리움", "쓸쓸", "허전", "아쉬워", "외로",
    "우울해", "마음이 아파", "상실감", "후회", "허탈", "그리움", "서글픔", "절망", "상실",
    "한숨", "허무", "낙담", "고독", "애달픔", "슬픔", "마음허전", "울적", "마음공허", "서글퍼",
    "허전함", "우울감", "마음우울", "상심함", "그리움가득", "쓸쓸함", "상실감있음", "눈물흘림",
    "애잔", "허탈감", "한탄", "서운", "우울한마음", "상심가득", "외로움", "마음허전함", "슬퍼함",
    "허전함가득", "눈물남", "마음상심", "애처로움", "슬픔심리", "마음공허감", "쓸쓸가득"
    ],
    
    "흥미": [
    "흥미", "관심", "궁금", "호기심", "신기", "재미", "몰입", "즐겁", "탐구", "배우고싶",
    "알고싶", "관찰", "체험", "재밌어", "호기심발동", "호기심많", "즐거움", "몰두", "탐험",
    "신기함", "호기심강", "탐색", "흥미진진", "호기심가득", "관심있음", "궁금함", "재미있음",
    "몰입중", "관심많음", "신기해", "탐구심", "재미진진", "호기심높음", "재밌음", "탐험하고싶", 
    "흥미로움", "배우고싶음", "체험하고싶", "즐거워", "흥미강함", "관심가득", "몰두중", "흥미있음",
    "신기한", "흥미진진함", "재미가득", "탐구중", "관심중", "호기심가득함", "재미있는"
    ]
}



def _find_emotion(text: str) -> str:
    """한국어 키워드 기반 감정 분석 (가중치 포함)."""
    t = text.lower()
    emotion_scores = {}

    # 각 감정별로 키워드 매칭 점수 계산
    for emotion, keywords in EMOTION_KEYWORDS.items():
        score = 0
        for keyword in keywords:
            if keyword in t:
                # 정확한 단어 경계 매칭 시 가중치 증가
                if re.search(rf"\b{re.escape(keyword)}\b|{re.escape(keyword)}", t):
                    score += 2
                else:
                    score += 1
        emotion_scores[emotion] = score

    # 가장 높은 점수의 감정 반환, 동점이면 지침
    if emotion_scores and max(emotion_scores.values()) > 0:
        return max(emotion_scores, key=emotion_scores.get)

    return "지침"


def _estimate_intensity(text: str) -> int:
    # 길이, 강조어(너무, 매우, 진짜), 느낌표로 강도 추정
    score = 1
    l = len(text)
    if l > 100:
        score += 1
    if re.search(r"(너무|매우|정말|진짜)", text):
        score += 1
    if text.count("!") >= 1:
        score += 1
    if re.search(r"(매우|매우 많이|심하게)", text):
        score += 1
    return min(max(score, 1), 5)


def _detect_direction(text: str) -> str:
    t = text.lower()
    # 외부 요인 단서
    external_cues = ["학교", "회사", "사람", "친구", "선생님", "상사", "시험", "교통"]
    for cue in external_cues:
        if cue in t:
            return "외부"
    # 기본적으로 내부로 간주
    return "내부"


def analyze_text(text: str) -> Dict:
    """Return analysis: emotion, intensity (1-5), direction (내부/외부), short summary."""
    emo = _find_emotion(text)
    intensity = _estimate_intensity(text)
    direction = _detect_direction(text)

    summary = f"감정: {emo}, 강도: {intensity}/5, 방향: {direction}"

    return {
        "emotion": emo,
        "intensity": intensity,
        "direction": direction,
        "summary": summary,
    }


if __name__ == "__main__":
    print(analyze_text("오늘 학교에서 시험 때문에 너무 긴장했어. 집에 와서 울었다."))
